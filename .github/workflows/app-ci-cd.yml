name: app-ci-cd
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --------------------------------------------
  # JOB 1: Build & Test (CI)
  # --------------------------------------------
  build-test:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout your repo
      - uses: actions/checkout@v4

      # Step 2: Setup Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest

      # Step 4: Run tests
      - name: Run tests
        run: pytest -q

      # Step 5: Build Docker image (just validates Dockerfile)
      - name: Build Docker image
        run: |
          SHA=$(git rev-parse --short HEAD)
          docker build -t app:${SHA}-8111 .

      # Step 6: Hello artifact (warm-up)
      - name: Hello artifact
        run: echo "Hello from Harshaâ€™s pipeline run $GITHUB_RUN_ID" > hello-8111.txt

      # Step 7: Upload artifact
      - uses: actions/upload-artifact@v4
        with:
          name: hello-8111
          path: hello-8111.txt

  # --------------------------------------------
  # JOB 2: Deploy to AWS (CD)
  # --------------------------------------------
  deploy:
    needs: build-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1
      ECR_REPO: lab9-app-8111
      ECS_CLUSTER: lab9-cluster
      ECS_SERVICE: lab9-service
    steps:
      - uses: actions/checkout@v4

      # Step 1: Configure AWS credentials via OIDC
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::480664947885:role/GitHubActions-ECSDeploy-1234
          aws-region: ${{ env.AWS_REGION }}

      # Step 2: Login to Amazon ECR
      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Step 3: Build and push Docker image to ECR
      - name: Build and Push Image
        run: |
          set -e
          SHA=$(git rev-parse --short HEAD)
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGISTRY="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE="${REGISTRY}/${{ env.ECR_REPO }}:${SHA}-8111"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      # Step 4: Create new ECS task definition JSON
      - name: Render new task definition
        run: |
          cat <<EOF > taskdef.json
          {
            "family": "lab9-taskdef",
            "networkMode": "awsvpc",
            "requiresCompatibilities": ["FARGATE"],
            "cpu": "256",
            "memory": "512",
            "executionRoleArn": "arn:aws:iam::480664947885:role/ecsTaskExecutionRole",
            "containerDefinitions": [
              {
                "name": "lab9-container",
                "image": "${IMAGE}",
                "essential": true,
                "portMappings": [
                  {
                    "containerPort": 8080,
                    "protocol": "tcp"
                  }
                ]
              }
            ]
          }
          EOF

      # Step 5: Deploy new image to ECS
      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: taskdef.json
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
